<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />	<title>lithium\storage\session\strategy\Encrypt – Framework API v2.0.x – Documentation – li3 PHP-Framework</title>
		<link rel="stylesheet" href="/assets/v:__PROJECT_VERSION_BUILD__xyzz/css/reset.css" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Anonymous+Pro:400,700,400italic,700italic" />
	<link rel="stylesheet" href="/assets/v:__PROJECT_VERSION_BUILD__xyzz/css/u1m.css" />
	<link rel="stylesheet" href="/assets/v:__PROJECT_VERSION_BUILD__xyzz/css/li3_docs.css" />
	<link rel="stylesheet" href="/assets/v:__PROJECT_VERSION_BUILD__xyzz/css/highlight.css" />
	
	
	<script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
	<script src="/assets/v:__PROJECT_VERSION_BUILD__xyzz/js/base.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js"></script>
	
	
	<link rel="icon" href="/assets/ico/site.png">

		<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-11048416-4', 'auto');
	  ga('send', 'pageview');
	</script>
	</head>
<body class="layout-default li3-docs">
		<div id="container">
			<header class="main">
	<div class="left">
		<h1><a href="/" class="li3-logo">li3</a></h1>
	</div>
	<div class="right">
		<nav class="main-nav"><a href="http://news.li3.me">News</a><a href="/docs" class="active">Documentation</a><a href="/versions">Versions</a><a href="/present">Presentations</a><a href="/support">Community</a><a href="/development">Development</a></nav>	</div>
</header>							<nav class="crumbs">
	<ul itemscope itemtype="http://schema.org/BreadcrumbList">
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="1" />
							<a href="/docs" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Documentation</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="2" />
							<a href="/docs/api/lithium/2.0.x/lithium" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Framework API (2.0.x)</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="3" />
							<a href="/docs/api/lithium/2.0.x/lithium" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">lithium</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="4" />
							<a href="/docs/api/lithium/2.0.x/lithium/storage" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">storage</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="5" />
							<a href="/docs/api/lithium/2.0.x/lithium/storage/session" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">session</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="6" />
							<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">strategy</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="7" />
							<span itemscope itemprop="item" itemtype="http://schema.org/Thing">
					<span itemprop="name">Encrypt</span>
				</span>
					</li>
		</ul>
</nav>						<div id="content">
				<article class="apis-view has-aside-right">

	<nav class="aside aside-right">
			<h3 class="h-gamma">Contents</h3>
		<ul>
			<li class="nav-up"><a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy" rel="up">../</a>		</ul>
	
													
						<h3 class="h-gamma">Methods</h3>
			<ul>
												<li class="method public">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::__construct()">__construct()</a>												<li class="method public">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::read()">read()</a>												<li class="method public">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::write()">write()</a>												<li class="method public">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::delete()">delete()</a>												<li class="method protected">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::_encrypt()">_encrypt()</a>												<li class="method protected">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::_decrypt()">_decrypt()</a>												<li class="method public">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::enabled()">enabled()</a>												<li class="method protected">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::_hashSecret()">_hashSecret()</a>												<li class="method protected">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::_vector()">_vector()</a>												<li class="method protected">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::_vectorSize()">_vectorSize()</a>							</ul>
								<h3 class="h-gamma">Properties</h3>
			<ul>
												<li class="property protected">
				<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy/Encrypt::$_defaults">$_defaults</a>							</ul>
						</nav>
	<div class="body">
			<h1 class="h-alpha">
		<a href="/docs/api/lithium/2.0.x/lithium" class="symbol-segment">lithium</a>\<a href="/docs/api/lithium/2.0.x/lithium/storage" class="symbol-segment">storage</a>\<a href="/docs/api/lithium/2.0.x/lithium/storage/session" class="symbol-segment">session</a>\<a href="/docs/api/lithium/2.0.x/lithium/storage/session/strategy" class="symbol-segment">strategy</a>\Encrypt		</h1>

		<section class="under">
														<div class="extends">
					<span class="extends__title">Uses</span>
											AutoConfigurable									</div>
																<div class="tags">
																<span class="tag">class</span>
			</div>
		</section>

					
			<section>
									<div class="summary">
						<p>This strategy allows you to encrypt your <code>Session</code> and / or <code>Cookie</code> data so that it
is not stored in cleartext on the client side. You must provide a secret key, otherwise
an exception is raised.</p>
					</div>
				
									<div class="description">
						<p>To use this class, you need to have the <code>openssl</code> extension enabled.</p>
<p>Example configuration:</p>
<pre><code class="language-php">Session::config(['default' =&gt; [
   'adapter' =&gt; 'Cookie',
   'strategies' =&gt; ['Encrypt' =&gt; ['secret' =&gt; 'f00bar$l1thium']]
]]);
</code></pre>
<p>By default, this strategy uses the AES algorithm in the CBC mode. This means that an
initialization vector has to be generated and transported with the payload data. This
is done transparently, but you may want to keep this in mind (the ECB mode doesn't require
an initialization vector but is not recommended to use as it's insecure).</p>
<p>Please keep in mind that it is generally not a good idea to store sensitive information in
cookies (or generally on the client side) and this class is no exception to the rule. It allows
you to store client side data in a more secure way, but 100% security can't be achieved.</p>
<p>Also note that if you provide a secret that is shorter than the maximum key length of the
algorithm used, the secret will be hashed to make it more secure. This also means that if you
want to use your own hashing algorithm, make sure it has the maximum key length of the algorithm
used. See the <code>Encrypt::_hashSecret()</code> method for more information on this.</p>
					</div>
							</section>

			
			
			
			
						<section id="links">
				<h3 class="h-beta">Links</h3>
				<ul class="links">
									<li><a href="http://php.net/book.openssl.php" target="new">http://php.net/book.openssl.php</a>								</ul>
			</section>
			
			
						<section id="source" class="section">
				<h3 class="h-beta">Source</h3>
				<div id="source" class="source-display">
					<div class="source-wrapper">
						<pre class="source-code"><code class="language-php">class Encrypt {

	use AutoConfigurable;

	/**
	 * Default configuration.
	 */
	protected $_defaults = [
		&#039;secret&#039; =&gt; null
	];

	/**
	 * Constructor.
	 *
	 * @param array $config Configuration array.
	 * @return void
	 */
	public function __construct(array $config = []) {
		if (!isset($config[&#039;secret&#039;])) {
			throw new ConfigException(&#039;Encrypt strategy requires a secret key.&#039;);
		}
		if (!extension_loaded(&#039;openssl&#039;)) {
			throw new ConfigException(&#039;The `openssl` extension is not installed or enabled.&#039;);
		}
		$this-&gt;_autoConfig($config + $this-&gt;_defaults, []);
		$this-&gt;_autoInit($config);
	}

	/**
	 * Read encryption method.
	 *
	 * @param array $data the Data being read.
	 * @param array $options Options for this method.
	 * @return mixed Returns the decrypted data after it was read.
	 */
	public function read($data, array $options = []) {
		$class = $options[&#039;class&#039;];

		$encrypted = $class::read(null, [&#039;strategies&#039; =&gt; false]);
		$key = isset($options[&#039;key&#039;]) ? $options[&#039;key&#039;] : null;

		if (!isset($encrypted[&#039;__encrypted&#039;]) || !$encrypted[&#039;__encrypted&#039;]) {
			return isset($encrypted[$key]) ? $encrypted[$key] : null;
		}
		$current = $this-&gt;_decrypt($encrypted[&#039;__encrypted&#039;]);

		if ($key) {
			return isset($current[$key]) ? $current[$key] : null;
		}
		return $current;
	}

	/**
	 * Write encryption method.
	 *
	 * @param mixed $data The data to be encrypted.
	 * @param array $options Options for this method.
	 * @return string Returns the encrypted data that was written.
	 */
	public function write($data, array $options = []) {
		$class = $options[&#039;class&#039;];

		$futureData = $this-&gt;read(null, [&#039;key&#039; =&gt; null] + $options) ?: [];
		$futureData = [$options[&#039;key&#039;] =&gt; $data] + $futureData;

		$payload = null;

		if (!empty($futureData)) {
			$payload = $this-&gt;_encrypt($futureData);
		}

		$class::write(&#039;__encrypted&#039;, $payload, [&#039;strategies&#039; =&gt; false] + $options);
		return $payload;
	}

	/**
	 * Delete encryption method.
	 *
	 * @param mixed $data The data to be encrypted.
	 * @param array $options Options for this method.
	 * @return string Returns the deleted data in cleartext.
	 */
	public function delete($data, array $options = []) {
		$class = $options[&#039;class&#039;];

		$futureData = $this-&gt;read(null, [&#039;key&#039; =&gt; null] + $options) ?: [];
		unset($futureData[$options[&#039;key&#039;]]);

		$payload = null;

		if (!empty($futureData)) {
			$payload = $this-&gt;_encrypt($futureData);
		}

		$class::write(&#039;__encrypted&#039;, $payload, [&#039;strategies&#039; =&gt; false] + $options);
		return $data;
	}

	/**
	 * Serialize and encrypt a given data array.
	 *
	 * @param array $decrypted The cleartext data to be encrypted.
	 * @return string A Base64 encoded and encrypted string.
	 */
	protected function _encrypt($decrypted = []) {
		$encrypted = openssl_encrypt(
			serialize($decrypted),
			&#039;aes-256-cbc&#039;,
			$this-&gt;_hashSecret($this-&gt;_config[&#039;secret&#039;]),
			OPENSSL_RAW_DATA,
			$vector = $this-&gt;_vector()
		);
		return base64_encode($encrypted) . base64_encode($vector);
	}

	/**
	 * Decrypt and unserialize a previously encrypted string.
	 *
	 * @param string $encrypted The base64 encoded and encrypted string.
	 * @return array The cleartext data.
	 */
	protected function _decrypt($encrypted) {
		$secret = $this-&gt;_hashSecret($this-&gt;_config[&#039;secret&#039;]);

		$vectorSize = strlen(base64_encode(str_repeat(&#039; &#039;, $this-&gt;_vectorSize())));
		$vector = base64_decode(substr($encrypted, -$vectorSize));
		$data = base64_decode(substr($encrypted, 0, -$vectorSize));

		$decrypted = openssl_decrypt(
			$data,
			&#039;aes-256-cbc&#039;,
			$secret,
			OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING,
			$vector
		);
		return unserialize(trim($decrypted));
	}

	/**
	 * Determines if the `mcrypt` or `openssl` extension has been installed.
	 *
	 * @return boolean `true` if enabled, `false` otherwise.
	 */
	public static function enabled() {
		return extension_loaded(&#039;openssl&#039;) || extension_loaded(&#039;mcrypt&#039;);
	}

	/**
	 * Hashes the given secret to make harder to detect.
	 *
	 * This method figures out the appropriate key size for the chosen encryption algorithm and
	 * then hashes the given key accordingly. Note that if the key has already the needed length,
	 * it is considered to be hashed (secure) already and is therefore not hashed again. This lets
	 * you change the hashing method in your own code if you like.
	 *
	 * The default `aes-256-cbc` key should be 32 byte long `sha256` is used as the
	 * hashing algorithm. If the key size is shorter than the one generated by `sha256`,
	 * the first n bytes will be used.
	 *
	 * @param string $key The possibly too weak key.
	 * @return string The hashed (raw) key.
	 */
	protected function _hashSecret($key) {
		if (strlen($key) &gt;= 32) {
			return $key;
		}
		return substr(hash(&#039;sha256&#039;, $key, true), 0, 32);
	}

	/**
	 * Generates an initialization vector.
	 *
	 * @return string Returns an initialization vector.
	 */
	protected function _vector() {
		return Random::generate($this-&gt;_vectorSize());
	}

	/**
	 * Returns the vector size.
	 *
	 * @return integer The vector size in bytes.
	 */
	protected function _vectorSize() {
		return openssl_cipher_iv_length(&#039;aes-256-cbc&#039;);
	}
}</code></pre>
					</div>
				</div>
			</section>
							</div>
	</article>			</div>
		</div>
		<footer class="main">
	<div class="area"></div>
	<div class="area"></div>
	<div class="area"></div>
	<div class="area"></div>

	<div class="social">
		<a href="https://github.com/unionofrad" target="new">GitHub</a>		<span class="separator">/</span>
		<a href="https://twitter.com/unionofrad" target="new">Twitter</a>		<span class="separator">/</span>
		<a href="http://www.reddit.com/r/li3" target="new">Reddit</a>		<span class="separator">/</span>
		<a href="https://stackoverflow.com/questions/tagged/lithium" target="new">Stack Overflow</a>	</div>
	<div class="testimonial">
		<img src="/assets/v:__PROJECT_VERSION_BUILD__xyzz/img/testimonials/10.png" alt="Testimonial Image" />		<p>I think it's time you started<br />
writing better code.</p>
	</div>
	<div class="copyright">
		Pretty much everything is (c) 2009-2024 and beyond, the <a href="http://unionofrad.org">Union of RAD</a>.	</div>
</footer>	</body>
</body>
</html>
