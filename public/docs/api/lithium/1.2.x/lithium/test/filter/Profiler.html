<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />	<title>lithium\test\filter\Profiler – Framework API v1.2.x – Documentation – li3 PHP-Framework</title>
		<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/reset.css" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Anonymous+Pro:400,700,400italic,700italic" />
	<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/u1m.css" />
	<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/li3_docs.css" />
	<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/highlight.css" />
	
	
	<script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
	<script src="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/js/base.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js"></script>
	
	
	<link rel="icon" href="../../../../../../../assets/ico/site.png">

		<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-11048416-4', 'auto');
	  ga('send', 'pageview');
	</script>
	</head>
<body class="layout-default li3-docs">
		<div id="container">
			<header class="main">
	<div class="left">
		<h1><a href="../../../../../../../index.html" class="li3-logo">li3</a></h1>
	</div>
	<div class="right">
		<nav class="main-nav"><a href="http://news.li3.me">News</a><a href="../../../../../../../docs.html" class="active">Documentation</a><a href="../../../../../../../versions.html">Versions</a><a href="../../../../../../../present.html">Presentations</a><a href="../../../../../../../support.html">Community</a><a href="../../../../../../../development.html">Development</a></nav>	</div>
</header>							<nav class="crumbs">
	<ul itemscope itemtype="http://schema.org/BreadcrumbList">
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="1" />
							<a href="../../../../../../../docs.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Documentation</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="2" />
							<a href="../../../lithium.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Framework API (1.2.x)</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="3" />
							<a href="../../../lithium.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">lithium</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="4" />
							<a href="../../test.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">test</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="5" />
							<a href="../filter.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">filter</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="6" />
							<span itemscope itemprop="item" itemtype="http://schema.org/Thing">
					<span itemprop="name">Profiler</span>
				</span>
					</li>
		</ul>
</nav>						<div id="content">
				<article class="apis-view has-aside-right">

	<nav class="aside aside-right">
			<h3 class="h-gamma">Contents</h3>
		<ul>
			<li class="nav-up"><a href="../filter.html" rel="up">../</a>		</ul>
	
													
						<h3 class="h-gamma">Methods</h3>
			<ul>
												<li class="method public">
				<a href="./Profiler::reset().html">reset()</a>												<li class="method public">
				<a href="./Profiler::apply().html">apply()</a>												<li class="method public">
				<a href="./Profiler::analyze().html">analyze()</a>												<li class="method public">
				<a href="./Profiler::check().html">check()</a>												<li class="method public">
				<a href="./Profiler::collect().html">collect()</a>												<li class="method public deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::respondsTo().html">respondsTo()</a>												<li class="method public deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::invokeMethod().html">invokeMethod()</a>												<li class="method protected deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::_instance().html">_instance()</a>												<li class="method protected deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::_stop().html">_stop()</a>												<li class="method protected deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::_parents().html">_parents()</a>												<li class="method public deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::applyFilter().html">applyFilter()</a>												<li class="method protected deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::_filter().html">_filter()</a>							</ul>
								<h3 class="h-gamma">Properties</h3>
			<ul>
												<li class="property protected">
				<a href="./Profiler::$_metrics.html">$_metrics</a>												<li class="property protected">
				<a href="./Profiler::$_formatters.html">$_formatters</a>												<li class="property protected deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::$_parents.html">$_parents</a>												<li class="property protected deprecated inherited">
				<a href="../../core/StaticObjectDeprecated::$_methodFilters.html">$_methodFilters</a>							</ul>
						</nav>
	<div class="body">
			<h1 class="h-alpha">
		<a href="../../../lithium.html" class="symbol-segment">lithium</a>\<a href="../../test.html" class="symbol-segment">test</a>\<a href="../filter.html" class="symbol-segment">filter</a>\Profiler		</h1>

		<section class="under">
													<div class="extends">
					<span class="extends__title">Extends</span>
											<a href="../Filter.html" class="extends__symbol">lithium\test\Filter</a>									</div>
									<div class="tags">
																<span class="tag">class</span>
			</div>
		</section>

					
			<section>
									<div class="summary">
						<p>The <code>Profiler</code> filter tracks timing and memory usage information for each test method, and
presents aggregate reports across single test runs. Used for performance-tuning classes and
methods.</p>
					</div>
				
							</section>

			
			
			
			
			
			
						<section id="source" class="section">
				<h3 class="h-beta">Source</h3>
				<div id="source" class="source-display">
					<div class="source-wrapper">
						<pre class="source-code"><code class="language-php">class Profiler extends \lithium\test\Filter {

	/**
	 * Contains the list of profiler checks to run against each test.  Values can be string
	 * function names, arrays containing function names as the first key and function parameters
	 * as subsequent keys, or closures.
	 *
	 * @var array
	 * @see lithium\test\Profiler::check()
	 */
	protected static $_metrics = [
		&#039;Time&#039; =&gt; [
			&#039;function&#039; =&gt; [&#039;microtime&#039;, true],
			&#039;format&#039; =&gt; &#039;seconds&#039;
		],
		&#039;Current Memory&#039; =&gt; [
			&#039;function&#039; =&gt; &#039;memory_get_usage&#039;,
			&#039;format&#039; =&gt; &#039;bytes&#039;
		],
		&#039;Peak Memory&#039; =&gt; [
			&#039;function&#039; =&gt; &#039;memory_get_peak_usage&#039;,
			&#039;format&#039; =&gt; &#039;bytes&#039;
		],
		&#039;Current Memory (Xdebug)&#039; =&gt; [
			&#039;function&#039; =&gt; &#039;xdebug_memory_usage&#039;,
			&#039;format&#039; =&gt; &#039;bytes&#039;
		],
		&#039;Peak Memory (Xdebug)&#039; =&gt; [
			&#039;function&#039; =&gt; &#039;xdebug_peak_memory_usage&#039;,
			&#039;format&#039; =&gt; &#039;bytes&#039;
		]
	];

	protected static $_formatters = [];

	/**
	 * Verifies that the corresponding function exists for each built-in profiler check.
	 * Initializes display formatters.
	 */
	public static function reset() {
		foreach (static::$_metrics as $name =&gt; $check) {
			if (is_string($check[&#039;function&#039;]) &amp;&amp; !function_exists($check[&#039;function&#039;])) {
				unset(static::$_metrics[$name]);
			}
		}

		static::$_formatters = [
			&#039;seconds&#039; =&gt; function($value) { return number_format($value, 4) . &#039;s&#039;; },
			&#039;bytes&#039; =&gt; function($value) { return number_format($value / 1024, 3) . &#039;k&#039;; }
		];
	}

	/**
	 * Takes an instance of an object (usually a Collection object) containing test
	 * instances. Allows for preparing tests before they are run.
	 *
	 * @param object $report Instance of Report which is calling apply.
	 * @param \lithium\util\Collection $tests The tests to apply this filter on.
	 * @param array $options Options for how this filter should be applied. Available options are:
	 *              - `&#039;method&#039;`
	 *              - `&#039;run&#039;`
	 *              - `&#039;checks&#039;`
	 * @return object Returns the instance of `$tests`.
	 */
	public static function apply($report, $tests, array $options = []) {
		$defaults = [&#039;method&#039; =&gt; &#039;run&#039;, &#039;checks&#039; =&gt; static::$_metrics];
		$options += $defaults;

		foreach ($tests as $test) {
			$filter = function($params, $next) use ($report, $options, $test) {
				$start = $results = [];

				$runCheck = function($check) {
					switch (true) {
						case (is_object($check) || is_string($check)):
							return $check();
						break;
						case (is_array($check)):
							$function = array_shift($check);
							$result = !$check ? $check() : call_user_func_array($function, $check);
						break;
					}
					return $result;
				};

				foreach ($options[&#039;checks&#039;] as $name =&gt; $check) {
					$start[$name] = $runCheck($check[&#039;function&#039;]);
				}
				$methodResult = $next($params);

				foreach ($options[&#039;checks&#039;] as $name =&gt; $check) {
					$results[$name] = $runCheck($check[&#039;function&#039;]) - $start[$name];
				}
				$report-&gt;collect(
					__CLASS__,
					[
						$test-&gt;subject() =&gt; $results,
						&#039;options&#039; =&gt; $options + [&#039;test&#039; =&gt; get_class($test)],
						&#039;method&#039; =&gt; $params[&#039;method&#039;]
					]
				);
				return $methodResult;
			};
			Filters::apply($test, $options[&#039;method&#039;], $filter);
		}
		return $tests;
	}

	/**
	 * Analyzes the results of a test run and returns the result of the analysis.
	 *
	 * @param object $report The report instance running this filter and aggregating results
	 * @param array $options Not used.
	 * @return array The results of the analysis.
	 */
	public static function analyze($report, array $options = []) {
		$results = $report-&gt;results[&#039;group&#039;];
		$collectedResults = static::collect($report-&gt;results[&#039;filters&#039;][__CLASS__]);
		extract($collectedResults, EXTR_OVERWRITE);
		$metrics = [];

		foreach ($results as $testCase) {
			foreach ((array) $testCase as $assertion) {
				if ($assertion[&#039;result&#039;] !== &#039;pass&#039; &amp;&amp; $assertion[&#039;result&#039;] !== &#039;fail&#039;) {
					continue;
				}
				$class = $classMap[$assertion[&#039;class&#039;]];

				if (!isset($metrics[$class])) {
					$metrics[$class] = [&#039;assertions&#039; =&gt; 0];
				}
				$metrics[$class][&#039;assertions&#039;]++;
			}
		}

		foreach ($filterResults as $class =&gt; $methods) {
			foreach ($methods as $methodName =&gt; $timers) {
				foreach ($timers as $title =&gt; $value) {
					if (!isset($metrics[$class][$title])) {
						$metrics[$class][$title] = 0;
					}
					$metrics[$class][$title] += $value;
				}
			}
		}

		$totals = [];
		foreach ($metrics as $class =&gt; $data) {
			foreach ($data as $title =&gt; $value) {
				if (isset(static::$_metrics[$title])) {
					if (isset($totals[$title][&#039;value&#039;])) {
						$totals[$title][&#039;value&#039;] += $value;
					} else {
						$totals[$title][&#039;value&#039;] = $value;
					}

					if (!isset($totals[$title][&#039;format&#039;])) {
						$format = static::$_metrics[$title][&#039;format&#039;];
						$totals[$title][&#039;formatter&#039;] = static::$_formatters[$format];
					}
				}
			}
		}

		$metrics[&#039;totals&#039;] = $totals;
		return $metrics;
	}

	/**
	 * Add, remove, or modify a profiler check.
	 *
	 * @see lithium\test\Profiler::$_metrics
	 * @param mixed $name
	 * @param string $value
	 * @return mixed
	 */
	public function check($name, $value = null) {
		if ($value === null &amp;&amp; !is_array($name)) {
			return isset(static::$_metrics[$name]) ? static::$_metrics[$name] : null;
		}

		if ($value === false) {
			unset(static::$_metrics[$name]);
			return;
		}

		if (!empty($value)) {
			static::$_metrics[$name] = $value;
		}

		if (is_array($name)) {
			static::$_metrics = $name + static::$_metrics;
		}
	}

	/**
	 * Collects the raw filter results and packages them for analysis.
	 *
	 * @param array $filterResults The results of the filter on the test run.
	 * @return array The packaged filter results prepared for analysis.
	 */
	public static function collect($filterResults) {
		$defaults = [&#039;test&#039; =&gt; null];
		$classMap = [];
		$packagedResults = [];

		foreach ($filterResults as $results) {
			$class = key($results);
			$options = $results[&#039;options&#039;];
			$options += $defaults;
			$method = $results[&#039;method&#039;];

			$classMap[$options[&#039;test&#039;]] = $class;
			if (!isset($packagedResults[$class])) {
				$packagedResults[$class] = [];
			}
			$packagedResults[$class][$method] = $results[$class];
		}

		$filterResults = $packagedResults;

		return [
			&#039;filterResults&#039; =&gt; $filterResults,
			&#039;classMap&#039; =&gt; $classMap
		];
	}
}</code></pre>
					</div>
				</div>
			</section>
							</div>
	</article>			</div>
		</div>
		<footer class="main">
	<div class="area"></div>
	<div class="area"></div>
	<div class="area"></div>
	<div class="area"></div>

	<div class="social">
		<a href="https://github.com/unionofrad" target="new">GitHub</a>		<span class="separator">/</span>
		<a href="https://twitter.com/unionofrad" target="new">Twitter</a>		<span class="separator">/</span>
		<a href="http://www.reddit.com/r/li3" target="new">Reddit</a>		<span class="separator">/</span>
		<a href="https://stackoverflow.com/questions/tagged/lithium" target="new">Stack Overflow</a>	</div>
	<div class="testimonial">
		<img src="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/img/testimonials/10.png" alt="Testimonial Image" />		<p>I think it's time you started<br />
writing better code.</p>
	</div>
	<div class="copyright">
		Pretty much everything is (c) 2009-2024 and beyond, the <a href="http://unionofrad.org">Union of RAD</a>.	</div>
</footer>	</body>
</body>
</html>
