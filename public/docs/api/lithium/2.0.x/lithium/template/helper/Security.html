<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />	<title>lithium\template\helper\Security – Framework API v2.0.x – Documentation – li3 PHP-Framework</title>
		<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/reset.css" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Anonymous+Pro:400,700,400italic,700italic" />
	<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/u1m.css" />
	<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/li3_docs.css" />
	<link rel="stylesheet" href="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/css/highlight.css" />
	
	
	<script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
	<script src="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/js/base.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js"></script>
	
	
	<link rel="icon" href="../../../../../../../assets/ico/site.png">

		<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-11048416-4', 'auto');
	  ga('send', 'pageview');
	</script>
	</head>
<body class="layout-default li3-docs">
		<div id="container">
			<header class="main">
	<div class="left">
		<h1><a href="../../../../../../../index.html" class="li3-logo">li3</a></h1>
	</div>
	<div class="right">
		<nav class="main-nav"><a href="http://news.li3.me">News</a><a href="../../../../../../../docs.html" class="active">Documentation</a><a href="../../../../../../../versions.html">Versions</a><a href="../../../../../../../present.html">Presentations</a><a href="../../../../../../../support.html">Community</a><a href="../../../../../../../development.html">Development</a></nav>	</div>
</header>							<nav class="crumbs">
	<ul itemscope itemtype="http://schema.org/BreadcrumbList">
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="1" />
							<a href="../../../../../../../docs.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Documentation</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="2" />
							<a href="../../../lithium.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Framework API (2.0.x)</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="3" />
							<a href="../../../lithium.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">lithium</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="4" />
							<a href="../../template.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">template</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="5" />
							<a href="../helper.html" itemscope itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">helper</span></a>
					</li>
			<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
			<meta itemprop="position" content="6" />
							<span itemscope itemprop="item" itemtype="http://schema.org/Thing">
					<span itemprop="name">Security</span>
				</span>
					</li>
		</ul>
</nav>						<div id="content">
				<article class="apis-view has-aside-right">

	<nav class="aside aside-right">
			<h3 class="h-gamma">Contents</h3>
		<ul>
			<li class="nav-up"><a href="../helper.html" rel="up">../</a>		</ul>
	
													
						<h3 class="h-gamma">Methods</h3>
			<ul>
												<li class="method public">
				<a href="./Security::__construct().html">__construct()</a>												<li class="method public">
				<a href="./Security::requestToken().html">requestToken()</a>												<li class="method public">
				<a href="./Security::sign().html">sign()</a>												<li class="method protected inherited">
				<a href="../Helper::_init().html">_init()</a>												<li class="method public inherited">
				<a href="../Helper::escape().html">escape()</a>												<li class="method public inherited">
				<a href="../Helper::attributes().html">attributes()</a>												<li class="method protected inherited">
				<a href="../Helper::_attribute().html">_attribute()</a>												<li class="method protected inherited">
				<a href="../Helper::_options().html">_options()</a>												<li class="method protected inherited">
				<a href="../Helper::_render().html">_render()</a>							</ul>
								<h3 class="h-gamma">Properties</h3>
			<ul>
												<li class="property protected">
				<a href="./Security::$_classes.html">$_classes</a>												<li class="property protected">
				<a href="./Security::$_state.html">$_state</a>												<li class="property public inherited">
				<a href="../Helper::$contentMap.html">$contentMap</a>												<li class="property protected inherited">
				<a href="../Helper::$_strings.html">$_strings</a>												<li class="property protected inherited">
				<a href="../Helper::$_context.html">$_context</a>												<li class="property protected inherited">
				<a href="../Helper::$_autoConfig.html">$_autoConfig</a>												<li class="property protected inherited">
				<a href="../Helper::$_minimized.html">$_minimized</a>							</ul>
						</nav>
	<div class="body">
			<h1 class="h-alpha">
		<a href="../../../lithium.html" class="symbol-segment">lithium</a>\<a href="../../template.html" class="symbol-segment">template</a>\<a href="../helper.html" class="symbol-segment">helper</a>\Security		</h1>

		<section class="under">
													<div class="extends">
					<span class="extends__title">Extends</span>
											<a href="../Helper.html" class="extends__symbol">lithium\template\Helper</a>									</div>
									<div class="tags">
																<span class="tag">class</span>
			</div>
		</section>

					
			<section>
									<div class="summary">
						<p>The <code>Security</code> helper is responsible for various tasks associated with verifying the authenticity
of requests, including embedding secure tokens to protect against CSRF attacks, and signing forms
to prevent adding or removing fields, or tampering with fields that are designated 'locked'.</p>
					</div>
				
							</section>

			
			
			
						<section id="related">
				<h3 class="h-beta">Related</h3>
				<ul class="related">
									<li><a href="../../security/validation/RequestToken.html">lithium\security\validation\RequestToken</a>								</ul>
			</section>
			
			
			
						<section id="source" class="section">
				<h3 class="h-beta">Source</h3>
				<div id="source" class="source-display">
					<div class="source-wrapper">
						<pre class="source-code"><code class="language-php">class Security extends \lithium\template\Helper {

	protected $_classes = [
		&#039;requestToken&#039; =&gt; &#039;lithium\security\validation\RequestToken&#039;,
		&#039;formSignature&#039; =&gt; &#039;lithium\security\validation\FormSignature&#039;
	];

	protected $_state = [];

	/**
	 * Constructor. Configures the helper with the default settings for interacting with
	 * security tokens.
	 *
	 * @param array $config
	 * @return void
	 */
	public function __construct(array $config = []) {
		$defaults = [&#039;sessionKey&#039; =&gt; &#039;security.token&#039;, &#039;salt&#039; =&gt; null];
		parent::__construct($config + $defaults);
	}

	/**
	 * Generates a request key used to protect your forms against CSRF attacks. See the
	 * `RequestToken` class for examples and proper usage.
	 *
	 * @see lithium\security\validation\RequestToken
	 * @param array $options Options used as HTML when generating the field.
	 * @return string Returns a hidden `&lt;input /&gt;` field containing a request-specific CSRF token
	 *         key.
	 */
	public function requestToken(array $options = []) {
		$defaults = [&#039;name&#039; =&gt; &#039;security.token&#039;, &#039;id&#039; =&gt; false];
		$options += $defaults;
		$requestToken = $this-&gt;_classes[&#039;requestToken&#039;];

		$flags = array_intersect_key($this-&gt;_config, [&#039;sessionKey&#039; =&gt; &#039;&#039;, &#039;salt&#039; =&gt; &#039;&#039;]);
		$value = $requestToken::key($flags);

		$name = $options[&#039;name&#039;];
		unset($options[&#039;name&#039;]);
		return $this-&gt;_context-&gt;form-&gt;hidden($name, compact(&#039;value&#039;) + $options);
	}

	/**
	 * Binds the `Security` helper to the `Form` helper to create a signature used to secure form
	 * fields against tampering.
	 *
	 * First `FormSignature` must be provided with a secret unique to your app. This is best
	 * done in the bootstrap process. The secret key should be a random lengthy string.
	 * ```php
	 * use lithium\security\validation\FormSignature;
	 * FormSignature::config([&#039;secret&#039; =&gt; &#039;a long secret key&#039;]);
	 * ```
	 *
	 * In the view call the `sign()` method before creating the form.
	 * ```php
	 * &lt;?php $this-&gt;security-&gt;sign(); ?&gt;
	 * &lt;?=$this-&gt;form-&gt;create(...); ?&gt;
	 *     // Form fields...
	 * &lt;?=$this-&gt;form-&gt;end(); ?&gt;
	 * ```
	 *
	 * In the corresponding controller action verify the signature.
	 * ```php
	 * if ($this-&gt;request-&gt;is(&#039;post&#039;) &amp;&amp; !FormSignature::check($this-&gt;request)) {
	 *     // The key didn&#039;t match, meaning the request has been tampered with.
	 * }
	 * ```
	 *
	 * Calling this method before a form is created adds two additional options to the `$options`
	 * parameter in all form inputs:
	 *
	 * - `&#039;locked&#039;` _boolean_: If `true`, _locks_ the value specified in the field when the field
	 *   is generated, such that tampering with the value will invalidate the signature. Defaults
	 *   to `true` for hidden fields, and `false` for all other form inputs.
	 *
	 * - `&#039;exclude&#039;` _boolean_: If `true`, this field and all subfields of the same name will be
	 *   excluded from the signature calculation. This is useful in situations where fields may be
	 *   added dynamically on the client side. Defaults to `false`.
	 *
	 * @see lithium\template\helper\Form
	 * @see lithium\security\validation\FormSignature
	 * @param object $form Optional. Allows specifying an instance of the `Form` helper manually.
	 * @return void
	 */
	public function sign($form = null) {
		$form = $form ?: $this-&gt;_context-&gt;form;

		if (isset($state[spl_object_hash($form)])) {
			return;
		}

		Filters::apply($form, &#039;create&#039;, function($params, $next) use ($form) {
			$this-&gt;_state[spl_object_hash($form)] = [
				&#039;fields&#039; =&gt; [],
				&#039;locked&#039; =&gt; [],
				&#039;excluded&#039; =&gt; []
			];
			return $next($params);
		});

		Filters::apply($form, &#039;end&#039;, function($params, $next) use ($form) {
			$id = spl_object_hash($form);

			if (!$this-&gt;_state[$id]) {
				return $next($params);
			}
			$formSignature = $this-&gt;_classes[&#039;formSignature&#039;];

			$value = $formSignature::key($this-&gt;_state[$id]);
			echo $form-&gt;hidden(&#039;security.signature&#039;, compact(&#039;value&#039;));

			$this-&gt;_state[$id] = [];
			return $next($params);
		});

		Filters::apply($form, &#039;_defaults&#039;, function($params, $next) use ($form) {
			$defaults = [
				&#039;locked&#039; =&gt; ($params[&#039;method&#039;] === &#039;hidden&#039; &amp;&amp; $params[&#039;name&#039;] !== &#039;_method&#039;),
				&#039;exclude&#039; =&gt; $params[&#039;name&#039;] === &#039;_method&#039;
			];
			$options = $params[&#039;options&#039;];

			$options += $defaults;
			$params[&#039;options&#039;] = array_diff_key($options, $defaults);
			$result = $next($params);

			if ($params[&#039;method&#039;] === &#039;label&#039;) {
				return $result;
			}
			$value = isset($params[&#039;options&#039;][&#039;value&#039;]) ? $params[&#039;options&#039;][&#039;value&#039;] : &quot;&quot;;

			$type = [
				$options[&#039;exclude&#039;]  =&gt; &#039;excluded&#039;,
				!$options[&#039;exclude&#039;] =&gt; &#039;fields&#039;,
				$options[&#039;locked&#039;]   =&gt; &#039;locked&#039;
			];
			if (!$name = preg_replace(&#039;/(\.\d+)+$/&#039;, &#039;&#039;, $params[&#039;name&#039;] ?? &#039;&#039;)) {
				return $result;
			}
			$this-&gt;_state[spl_object_hash($form)][$type[true]][$name] = $value;
			return $result;
		});
	}
}</code></pre>
					</div>
				</div>
			</section>
							</div>
	</article>			</div>
		</div>
		<footer class="main">
	<div class="area"></div>
	<div class="area"></div>
	<div class="area"></div>
	<div class="area"></div>

	<div class="social">
		<a href="https://github.com/unionofrad" target="new">GitHub</a>		<span class="separator">/</span>
		<a href="https://twitter.com/unionofrad" target="new">Twitter</a>		<span class="separator">/</span>
		<a href="http://www.reddit.com/r/li3" target="new">Reddit</a>		<span class="separator">/</span>
		<a href="https://stackoverflow.com/questions/tagged/lithium" target="new">Stack Overflow</a>	</div>
	<div class="testimonial">
		<img src="../../../../../../../assets/v:__PROJECT_VERSION_BUILD__xyzz/img/testimonials/10.png" alt="Testimonial Image" />		<p>I think it's time you started<br />
writing better code.</p>
	</div>
	<div class="copyright">
		Pretty much everything is (c) 2009-2024 and beyond, the <a href="http://unionofrad.org">Union of RAD</a>.	</div>
</footer>	</body>
</body>
</html>
